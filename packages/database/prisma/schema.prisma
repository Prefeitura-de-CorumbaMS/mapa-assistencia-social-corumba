// Mapa Assistência Social - Sistema de Gestão de Assistência Social de Corumbá (MS)
// Prisma Schema Definition

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PRODUCTION TABLES - Unidades de Assistência Social
// ============================================================================

model PROD_UnidadeAssistenciaSocial {
  id                     Int                                           @id @default(autoincrement())

  // Campos básicos (mantidos)
  nome                   String                                        @db.VarChar(255)
  endereco               String?                                       @db.VarChar(500)
  id_bairro              Int?
  latitude               Decimal                                       @db.Decimal(10, 8) // NOT NULL - obrigatório para mapa
  longitude              Decimal                                       @db.Decimal(11, 8) // NOT NULL - obrigatório para mapa
  telefone               String?                                       @db.VarChar(100)
  whatsapp               String?                                       @db.VarChar(100)
  email                  String?                                       @db.VarChar(255)
  horario_funcionamento  String?                                       @db.Text
  imagem_url             String?                                       @db.VarChar(500)
  icone_url              String?                                       @db.VarChar(500)  // Deprecated - usar id_icone
  id_icone               Int?
  ativo                  Boolean                                       @default(true)
  created_at             DateTime                                      @default(now())
  updated_at             DateTime                                      @updatedAt

  // CAMPOS ESPECÍFICOS
  nome_fantasia          String?                                       @db.VarChar(255)  // Nome comercial
  razao_social           String?                                       @db.VarChar(255)  // Nome empresarial
  cnpj                   String?                                       @db.VarChar(20)   // Cadastro
  setor                  String?                                       @db.VarChar(100)  // Ex: "CRAS", "CREAS"
  descricao_servicos     String?                                       @db.Text          // Descrição dos serviços oferecidos
  data_cadastro          DateTime?                                                       // Data de cadastro
  data_vencimento        DateTime?                                                       // Data de vencimento
  secretaria             String?                                       @db.VarChar(255)  // Nome do secretário
  secretaria_adjunta     String?                                       @db.VarChar(255)  // Nome do secretário adjunto

  // Relações
  bairro                 PROD_Bairro?                                  @relation(fields: [id_bairro], references: [id], onDelete: SetNull)
  icone                  PROD_Icone?                                   @relation(fields: [id_icone], references: [id], onDelete: SetNull)
  redes_sociais          PROD_UnidadeAssistenciaSocial_RedeSocial[]
  categorias             Junction_UnidadeAssistenciaSocial_Categoria[]
  setores                Junction_UnidadeSetor[]

  @@index([ativo])
  @@index([latitude, longitude])
  @@index([id_bairro])
  @@index([id_icone])
  @@index([setor])
  @@map("prod_unidade")
}

model PROD_UnidadeAssistenciaSocial_RedeSocial {
  id          Int                               @id @default(autoincrement())
  id_unidade  Int
  nome_rede   String                            @db.VarChar(50)
  url_perfil  String                            @db.VarChar(500)
  created_at  DateTime                          @default(now())
  updated_at  DateTime                          @updatedAt

  unidade     PROD_UnidadeAssistenciaSocial     @relation(fields: [id_unidade], references: [id], onDelete: Cascade)

  @@index([id_unidade])
  @@map("prod_unidade_redesocial")
}

// ============================================================================
// CATEGORIAS DE ASSISTÊNCIA SOCIAL
// ============================================================================

model PROD_Categoria {
  id            Int                                             @id @default(autoincrement())
  nome          String                                          @db.VarChar(100)         // Ex: "Proteção Social", "Benefícios"
  subcategoria  String?                                         @db.VarChar(100)         // Ex: "CRAS", "CREAS", "Bolsa Família"
  ativo         Boolean                                         @default(true)
  ordem         Int                                             @default(0)
  created_at    DateTime                                        @default(now())
  updated_at    DateTime                                        @updatedAt

  // Relações
  unidades      Junction_UnidadeAssistenciaSocial_Categoria[]

  @@unique([nome, subcategoria])  // Cada combinação categoria+subcategoria é única
  @@index([nome])
  @@index([ativo])
  @@map("prod_categoria")
}

// ============================================================================
// JUNCTION TABLES - Relações N:N
// ============================================================================

model Junction_UnidadeAssistenciaSocial_Categoria {
  id_unidade     Int
  id_categoria   Int
  created_at     DateTime                       @default(now())

  unidade        PROD_UnidadeAssistenciaSocial  @relation(fields: [id_unidade], references: [id], onDelete: Cascade)
  categoria      PROD_Categoria                 @relation(fields: [id_categoria], references: [id], onDelete: Cascade)

  @@id([id_unidade, id_categoria])
  @@index([id_unidade])
  @@index([id_categoria])
  @@map("junction_unidade_categoria")
}

// ============================================================================
// USER MANAGEMENT - Sistema de usuários e RBAC
// ============================================================================

model User {
  id                Int                              @id @default(autoincrement())
  username          String                           @unique @db.VarChar(50)
  email             String                           @unique @db.VarChar(255)
  password_hash     String                           @db.VarChar(255)
  role              UserRole                         @default(admin)
  ativo             Boolean                          @default(true)
  created_at        DateTime                         @default(now())
  updated_at        DateTime                         @updatedAt
  last_login        DateTime?

  // Relações
  audit_logs        AUDIT_LOG[]

  @@index([username])
  @@index([email])
  @@index([role])
  @@map("user")
}

enum UserRole {
  admin
  superadmin
}

// ============================================================================
// AUDIT SYSTEM - Sistema de auditoria imutável
// ============================================================================

model AUDIT_LOG {
  id                Int                              @id @default(autoincrement())
  tabela            String                           @db.VarChar(100)
  operacao          OperacaoAudit
  registro_id       Int
  valor_antigo      String?                          @db.Text // JSON
  valor_novo        String?                          @db.Text // JSON
  user_id           Int?
  correlation_id    String?                          @db.VarChar(100)
  timestamp         DateTime                         @default(now())

  // Relações
  user              User?                            @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([tabela])
  @@index([operacao])
  @@index([user_id])
  @@index([timestamp])
  @@index([correlation_id])
  @@map("audit_log")
}

enum OperacaoAudit {
  INSERT
  UPDATE
  DELETE
}

// ============================================================================
// BAIRROS - Gerenciamento de bairros de Corumbá
// ============================================================================

model PROD_Bairro {
  id         Int                            @id @default(autoincrement())
  nome       String                         @unique @db.VarChar(100)
  ativo      Boolean                        @default(true)
  created_at DateTime                       @default(now())
  updated_at DateTime                       @updatedAt

  // Relações
  unidades   PROD_UnidadeAssistenciaSocial[]

  @@index([nome])
  @@index([ativo])
  @@map("prod_bairro")
}

// ============================================================================
// ÍCONES - Gerenciamento de ícones para tipos de unidades de assistência social
// ============================================================================

model PROD_Icone {
  id         Int                            @id @default(autoincrement())
  nome       String                         @unique @db.VarChar(100) // Ex: CRAS, CREAS, Centro POP
  url        String                         @db.VarChar(500)
  ativo      Boolean                        @default(true)
  ordem      Int                            @default(0)
  created_at DateTime                       @default(now())
  updated_at DateTime                       @updatedAt

  // Relações
  unidades   PROD_UnidadeAssistenciaSocial[]

  @@index([ativo])
  @@index([ordem])
  @@map("prod_icone")
}

// ============================================================================
// SETORES - Setores das unidades de assistência social
// ============================================================================

model PROD_Setor {
  id         Int                          @id @default(autoincrement())
  nome       String                       @db.VarChar(255)
  gestor     String?                      @db.VarChar(255)
  numero     String?                      @db.VarChar(100)
  whatsapp   String?                      @db.VarChar(100)
  email      String?                      @db.VarChar(255)
  ativo      Boolean                      @default(true)
  created_at DateTime                     @default(now())
  updated_at DateTime                     @updatedAt

  // Relações
  unidades   Junction_UnidadeSetor[]

  @@index([ativo])
  @@index([nome])
  @@map("prod_setor")
}

// ============================================================================
// JUNCTION TABLE - Unidade ↔ Setor
// ============================================================================

model Junction_UnidadeSetor {
  id_unidade Int
  id_setor   Int
  created_at DateTime                       @default(now())

  unidade    PROD_UnidadeAssistenciaSocial  @relation(fields: [id_unidade], references: [id], onDelete: Cascade)
  setor      PROD_Setor                     @relation(fields: [id_setor], references: [id], onDelete: Cascade)

  @@id([id_unidade, id_setor])
  @@index([id_unidade])
  @@index([id_setor])
  @@map("junction_unidade_setor")
}

// ============================================================================
// ANALYTICS SYSTEM - Sistema de análise de uso e comportamento
// ============================================================================

model ANALYTICS_Event {
  id           BigInt   @id @default(autoincrement())
  session_id   String   @db.VarChar(255)
  event_type   String   @db.VarChar(50)  // PAGE_VIEW, SEARCH, UNIT_VIEW, MAP_CLICK, CONTACT_CLICK, SOCIAL_CLICK, FILTER_APPLIED, ERROR
  event_data   String?  @db.Text         // JSON com dados específicos do evento
  user_agent   String?  @db.VarChar(500)
  ip_hash      String?  @db.VarChar(64)  // SHA256 hash do IP (anonimizado)
  referrer     String?  @db.VarChar(500)
  created_at   DateTime @default(now())

  @@index([session_id])
  @@index([event_type])
  @@index([created_at])
  @@map("analytics_event")
}

model ANALYTICS_Session {
  id                BigInt   @id @default(autoincrement())
  session_id        String   @unique @db.VarChar(255)
  first_seen        DateTime @default(now())
  last_seen         DateTime @default(now())
  user_agent        String?  @db.VarChar(500)
  ip_hash           String?  @db.VarChar(64)
  page_views        Int      @default(0)
  searches          Int      @default(0)
  unit_views        Int      @default(0)
  contacts          Int      @default(0)
  duration_seconds  Int?     // Calculado: (last_seen - first_seen) em segundos

  @@index([first_seen])
  @@index([last_seen])
  @@map("analytics_session")
}

model ANALYTICS_UnitStats {
  id                   BigInt   @id @default(autoincrement())
  unit_id              Int
  date                 DateTime @db.Date
  views                Int      @default(0)
  map_clicks           Int      @default(0)
  contacts_whatsapp    Int      @default(0)
  contacts_phone       Int      @default(0)
  contacts_email       Int      @default(0)
  contacts_directions  Int      @default(0)

  @@unique([unit_id, date], name: "unit_id_date")
  @@index([unit_id])
  @@index([date])
  @@map("analytics_unit_stats")
}

model ANALYTICS_SearchStats {
  id            BigInt   @id @default(autoincrement())
  search_term   String   @db.VarChar(255)
  search_type   String   @db.VarChar(50)  // texto_livre, bairro, unidade, categoria, etc.
  count         Int      @default(1)
  last_searched DateTime @default(now())

  @@unique([search_term, search_type], name: "search_term_search_type")
  @@index([search_term])
  @@index([count])
  @@index([last_searched])
  @@map("analytics_search_stats")
}
